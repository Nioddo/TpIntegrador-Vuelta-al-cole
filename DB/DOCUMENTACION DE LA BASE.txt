#############################################################################
#                                                                           #
#        DOCUMENTACION DE LA BASE DE DATOS (V2): LÓGICA DE NEGOCIO          #
#                                                                           #
#############################################################################


### 1. Sistema de Reputación, Niveles y Confianza

Este conjunto de funcionalidades está diseñado para construir una comunidad segura y fomentar la participación.

#### 1.1. Calificaciones Mutuas
*   Concepto: Tras una venta, comprador y vendedor pueden calificarse mutuamente. La reputación de un usuario se muestra por separado para su rol de comprador y de vendedor.
*   Cómo funciona: Se usa el SP `sp_crear_calificacion`. Este procedimiento recibe los detalles de la calificación y se encarga de todo: la inserta y recalcula el promedio de reputación del usuario calificado de forma atómica y segura.
*   Interacción del Backend:
    *   Llamar a: `sp_crear_calificacion(IN p_id_venta, IN p_id_usuario_calificador, IN p_puntuacion, IN p_comentario, OUT out_success, OUT out_error_msg)`
    *   Cuándo: Cuando un usuario envía el formulario de calificación.

#### 1.2. Niveles y Puntos de Experiencia (XP)
*   Concepto: Los usuarios ganan XP por cada transacción (compra o venta), lo que les permite subir de nivel. Esto fomenta la actividad a largo plazo.
*   Cómo funciona: A través del Trigger `trg_actualizar_nivel_por_venta`.
*   Interacción del Backend: Ninguna. Esto es 100% automático. Cada vez que se inserta una venta, el trigger otorga 25 XP a ambos usuarios, recalcula su nivel consultando la tabla `niveles` y actualiza sus perfiles. También crea una notificación si suben de nivel.

#### 1.3. Verificación Automática de Usuarios
*   Concepto: Los usuarios que completan un número determinado de compras reciben una insignia de "verificado", aumentando la confianza en ellos.
*   Cómo funciona: A través del Trigger `trg_verificar_usuario_por_compras`.
*   Interacción del Backend: Ninguna. Esto es 100% automático. Después de cada venta, el trigger comprueba si el comprador ha alcanzado el umbral de 5 compras. Si es así, su campo `es_verificado` se actualiza a `1`.

---

### 2. Gestión de Contenido y Moderación

Herramientas para mantener la plataforma limpia, segura y relevante.

#### 2.1. Sistema de Reportes
*   Concepto: Los usuarios pueden reportar publicaciones, usuarios o chats por motivos predefinidos.
*   Cómo funciona: Se usa el SP `sp_crear_reporte`. El backend primero debe consultar la tabla `reportes_motivos` para mostrar las opciones al usuario. Luego, llama al SP para registrar el reporte.
*   Interacción del Backend:
    *   `SELECT * FROM reportes_motivos WHERE activo = 1` para obtener la lista de motivos.
    *   Llamar a: `sp_crear_reporte(IN p_id_usuario_reportante, IN p_id_usuario_reportado, IN p_id_motivo, IN p_descripcion_adicional, IN p_tipo_referencia, IN p_id_referencia, OUT out_id_reporte, OUT out_error_msg)` para crear el reporte.

#### 2.2. Borrado Lógico de Publicaciones (Soft Delete)
*   Concepto: Las publicaciones no se eliminan físicamente de la base de datos. En su lugar, se marcan como "eliminadas" para preservar el historial y la integridad de los datos.
*   Cómo funciona: Se usa el SP `sp_eliminar_publicacion`. Este procedimiento no borra la fila, sino que establece la columna `fecha_eliminacion` a la fecha actual y cambia el `estado` a 'Inactivo'.
*   Interacción del Backend:
    *   Para eliminar: Llamar a `sp_eliminar_publicacion(IN p_id_usuario_solicitante, IN p_id_publicacion_a_eliminar, OUT out_success, OUT out_error_msg)`. Nunca usar `DELETE FROM publicacion`.
    *   MUY IMPORTANTE: Todas las consultas `SELECT` que muestren publicaciones a los usuarios (búsquedas, perfiles, etc.) deben incluir la condición `AND fecha_eliminacion IS NULL` para ocultar las que han sido borradas.

---

### 3. Funcionalidades de Venta y Marketing

Herramientas para que los vendedores dinamicen sus ventas.

#### 3.1. Descuentos por Tiempo Limitado
*   Concepto: Un vendedor puede aplicar un descuento porcentual a una publicación durante un número determinado de días.
*   Cómo funciona:
    1.  El vendedor gestiona la oferta a través del SP `sp_gestionar_descuento_publicacion`. Este SP establece el porcentaje de descuento y las fechas de inicio/fin.
    2.  Un Evento (`ev_limpiar_descuentos_expirados`) se ejecuta automáticamente cada hora para limpiar las ofertas que ya han caducado, reseteando los campos de descuento.
*   Interacción del Backend:
    *   Para aplicar/modificar una oferta: `sp_gestionar_descuento_publicacion(IN p_id_usuario_vendedor, IN p_id_publicacion, IN p_descuento, IN p_dias_duracion, ...)`
    *   Para cancelar una oferta: `sp_gestionar_descuento_publicacion(..., p_descuento = 0, ...)`
    *   Para mostrar el precio: El backend debe calcular el precio final si una oferta está activa (`NOW() BETWEEN descuento_fecha_inicio AND descuento_fecha_fin`).

---

### 4. Herramientas Generales y Reportes

Procedimientos para uso del backend en diversas tareas.

#### 4.1. Creación Centralizada de Notificaciones
*   Concepto: Un único procedimiento para crear cualquier tipo de notificación, manteniendo el código limpio y centralizado.
*   Cómo funciona: El SP `sp_crear_notificacion` es un procedimiento genérico que simplemente inserta una fila en la tabla `notificaciones`.
*   Interacción del Backend: Llamar a `sp_crear_notificacion(IN p_id_usuario_destino, IN p_tipo, IN p_contenido, IN p_id_referencia)` siempre que se necesite notificar a un usuario sobre algo.

#### 4.2. Reporte de Compras por Usuario
*   Concepto: Obtener estadísticas sobre la cantidad de compras por usuario, con filtros opcionales.
*   Cómo funciona: El SP `sp_reporte_compras_por_usuario` devuelve una lista de usuarios y su total de compras. Los filtros por fecha y categoría son opcionales (enviar `NULL` para ignorarlos).
*   Interacción del Backend: Llamar a `sp_reporte_compras_por_usuario(IN p_fecha_inicio, IN p_fecha_fin, IN p_id_categoria)` para generar datos para paneles de administración o estadísticas de usuario.

---

### 5. Tareas Automáticas Programadas (Events)

Estas tareas se ejecutan solas en el servidor de la base de datos en horarios definidos. El backend no necesita hacer nada.

*   `ev_limpiar_descuentos_expirados`
    *   Qué hace: Resetea los descuentos de las publicaciones cuya oferta ha terminado.
    *   Cuándo: Cada hora.

*   `ev_notificar_mensajes_no_leidos`
    *   Qué hace: Envía una notificación de resumen a los usuarios con mensajes no leídos.
    *   Cuándo: Todos los días a las 8:00 AM.

*   `ev_revisar_publicaciones_antiguas`
    *   Qué hace: Cambia el estado a 'Necesita Revision' a las publicaciones activas con más de 6 meses de antigüedad.
    *   Cuándo: Todos los días a las 3:00 AM.

---
